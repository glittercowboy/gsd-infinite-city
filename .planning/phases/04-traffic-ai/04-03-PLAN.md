---
phase: 04-traffic-ai
plan: 03
type: execute
---

<objective>
Add traffic variety, intersection behavior, and performance optimization.

Purpose: Polish traffic system with visual variety and smarter behavior at road crossings.
Output: Varied car appearances, intersection yielding, optimized update loop.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-traffic-ai/04-01-SUMMARY.md
@.planning/phases/04-traffic-ai/04-02-SUMMARY.md

**Prior decisions affecting this phase:**
- Roads intersect at x=0,32,64 and z=0,32,64 positions
- InstancedMesh supports per-instance colors via instanceColor attribute

**Relevant source files:**
@src/traffic/TrafficManager.ts
@src/traffic/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add car variety (colors, speeds, sizes)</name>
  <files>src/traffic/TrafficManager.ts, src/traffic/types.ts</files>
  <action>
    Add visual and behavioral variety:
    1. Enable per-instance colors on InstancedMesh:
       - mesh.instanceColor = new THREE.InstancedBufferAttribute(colorArray, 3)
       - Or use setColorAt() method
    2. Random car colors from palette: [blue, green, yellow, white, silver, black]
    3. Speed variety: base speed 12-18 (randomized per car on spawn)
    4. Size variety: scale 0.8-1.2 (applied via matrix)

    Store in TrafficCar:
    - color: THREE.Color
    - baseSpeed: number (randomized on spawn)
    - scale: number

    Update setMatrixAt to include scale.
  </action>
  <verify>npm run dev - cars have different colors and sizes</verify>
  <done>Traffic has visual variety - different colors, speeds, sizes</done>
</task>

<task type="auto">
  <name>Task 2: Add intersection behavior</name>
  <files>src/traffic/TrafficManager.ts</files>
  <action>
    Add yielding at road intersections:
    1. Detect when car approaching intersection:
       - Intersections at chunk-relative positions: (0,0), (0,32), (32,0), (32,32)
       - Car is "approaching" if within 10 units of intersection center
    2. Simple yield rule: Z-lane cars yield to X-lane cars (right-of-way)
    3. Before entering intersection, check if any X-lane car within 15 units
    4. If X-lane car present, slow/stop until clear
    5. Once in intersection (past center), continue through

    Helper function: isNearIntersection(position) -> { near: boolean, intersectionPos: Vector3 }
    Helper function: shouldYield(car, otherCars) -> boolean

    This creates natural stop-and-go at crossings without traffic lights.
  </action>
  <verify>npm run build passes</verify>
  <done>Cars yield at intersections, no T-bone collisions</done>
</task>

<task type="auto">
  <name>Task 3: Performance optimization</name>
  <files>src/traffic/TrafficManager.ts</files>
  <action>
    Optimize update loop for many cars:
    1. Skip inactive cars early (continue if !car.active)
    2. Distance-based update frequency:
       - Cars within 100 units: update every frame
       - Cars 100-200 units: update every 2nd frame
       - Cars beyond 200 units: update every 4th frame
    3. Use frame counter to determine which cars update this frame
    4. Spatial partitioning for collision checks (optional if needed):
       - Simple grid: bucket cars by chunk position
       - Only check collisions within same/adjacent buckets
    5. Batch matrix updates: only call needsUpdate once after all cars processed

    Add to TrafficManager:
    - frameCount: number (increment each update)
    - carsByChunk: Map<string, number[]> (car indices per chunk key)

    Target: 60 FPS with 100 active cars
  </action>
  <verify>npm run dev - smooth 60 FPS, check with browser DevTools Performance tab</verify>
  <done>Traffic system runs smoothly with many cars, no frame drops</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Cars have varied colors and sizes
- [ ] Cars yield appropriately at intersections
- [ ] Performance remains smooth (60 FPS target)
- [ ] No visual glitches or popping
</verification>

<success_criteria>
- Visual variety in traffic
- Intersection behavior working
- Performance optimized for many cars
- Phase 4 complete
</success_criteria>

<output>
After completion, create `.planning/phases/04-traffic-ai/04-03-SUMMARY.md`

**Phase 4 COMPLETE** - Update STATE.md and ROADMAP.md progress.
</output>
