---
phase: 04-traffic-ai
plan: 01
type: execute
---

<objective>
Create TrafficManager with InstancedMesh rendering and lane-following AI cars that spawn per-chunk.

Purpose: Establish the foundation for traffic AI - efficient rendering and basic road-following behavior.
Output: TrafficManager class, AI cars visible on roads, spawn/despawn tied to chunk system.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Prior decisions affecting this phase:**
- Roads are fixed grid at x=0, x=32, z=0, z=32 per chunk (ROAD_WIDTH=8)
- Chunk size 64 units, view distance 3, cache distance 5
- InstancedMesh pattern already used for buildings/trees

**Relevant source files:**
@src/chunk/types.ts
@src/chunk/ChunkManager.ts
@src/car.ts
@src/scene.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TrafficManager with InstancedMesh</name>
  <files>src/traffic/TrafficManager.ts, src/traffic/types.ts</files>
  <action>
    Create TrafficManager class that:
    1. Maintains InstancedMesh for all AI cars (single draw call)
    2. Uses simple box geometry for car mesh (2x1x4 like player car)
    3. Stores per-car state in array: position, velocity, rotation, laneDirection, active flag
    4. Max 100 cars initially (can tune later)
    5. Update method that sets matrix for each active car using dummy Object3D pattern

    Types file with:
    - TrafficCar interface: { position: Vector3, velocity: Vector3, rotation: number, laneDir: 'x' | 'z', lanePos: number, speed: number, active: boolean }
    - TRAFFIC_CAR_COUNT = 100
    - TRAFFIC_CAR_SPEED = 15 (slower than player's 100 max)
  </action>
  <verify>npm run build passes, no TypeScript errors</verify>
  <done>TrafficManager class exists with InstancedMesh, types defined</done>
</task>

<task type="auto">
  <name>Task 2: Implement lane-following movement</name>
  <files>src/traffic/TrafficManager.ts</files>
  <action>
    Add update(deltaTime) method that for each active car:
    1. Move car along its lane direction (laneDir) at its speed
    2. Cars on X-lanes move in +X or -X direction
    3. Cars on Z-lanes move in +Z or -Z direction
    4. Set rotation to face movement direction (0 for +Z, PI for -Z, PI/2 for +X, -PI/2 for -X)
    5. Update InstancedMesh matrix using setMatrixAt with position/rotation
    6. Call instancedMesh.instanceMatrix.needsUpdate = true after all updates

    Lane positions are road centers:
    - X-lanes at z = chunkZ * 64 + [4, 28, 36, 60] (offset from road center, two lanes per road)
    - Z-lanes at x = chunkX * 64 + [4, 28, 36, 60]

    Two lanes per road (ROAD_WIDTH=8), cars drive on right side of road.
  </action>
  <verify>npm run build passes</verify>
  <done>Cars move along lanes in correct direction, face movement direction</done>
</task>

<task type="auto">
  <name>Task 3: Spawn/despawn cars based on player position</name>
  <files>src/traffic/TrafficManager.ts, src/scene.ts</files>
  <action>
    Add spawn/despawn logic:
    1. spawnCarsForChunk(chunkX, chunkZ) - spawn 2-4 cars per chunk on random lanes
    2. despawnCarsOutsideRange(playerPos, range) - deactivate cars beyond view distance * chunk size
    3. Cars spawn at random position along lane within chunk bounds
    4. 50% chance horizontal lane, 50% vertical lane
    5. Direction based on lane side (right-hand traffic)

    Integration in scene.ts:
    1. Create TrafficManager after ChunkManager
    2. Add trafficManager to scene
    3. In animate loop: call trafficManager.update(deltaTime, playerPosition)
    4. Hook into chunk load/unload or just check distance each frame

    Spawn distance: VIEW_DISTANCE chunks (3 * 64 = 192 units)
    Despawn distance: CACHE_DISTANCE chunks (5 * 64 = 320 units)
  </action>
  <verify>npm run dev - cars visible on roads, new cars appear as you drive, distant cars disappear</verify>
  <done>AI cars spawn on roads near player, despawn when far away</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] AI cars visible on roads when running dev server
- [ ] Cars move along lanes (not through buildings)
- [ ] Cars spawn as player explores new areas
- [ ] Cars despawn when player drives away
- [ ] No significant FPS drop (InstancedMesh efficient)
</verification>

<success_criteria>
- TrafficManager with InstancedMesh rendering
- Cars follow lanes on road grid
- Spawn/despawn based on player position
- Smooth performance with many cars
</success_criteria>

<output>
After completion, create `.planning/phases/04-traffic-ai/04-01-SUMMARY.md`
</output>
