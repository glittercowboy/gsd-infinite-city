---
phase: 04-traffic-ai
plan: 02
type: execute
---

<objective>
Add AI car collision avoidance and player-reactive behavior (honking, swerving).

Purpose: Make traffic feel alive and responsive rather than robotic rail-followers.
Output: Cars slow for cars ahead, react to player with honks and evasive maneuvers.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-traffic-ai/04-01-SUMMARY.md

**Prior decisions affecting this phase:**
- Square 4x4 collision box for cars (handles rotation)
- MTV-based collision from Phase 3
- Arcade physics style (fun over realism)

**Relevant source files:**
@src/traffic/TrafficManager.ts
@src/traffic/types.ts
@src/car.ts
@src/collision.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add car-to-car collision avoidance</name>
  <files>src/traffic/TrafficManager.ts</files>
  <action>
    Implement simple following distance logic:
    1. For each active car, check distance to other cars AHEAD in same lane
    2. "Ahead" = same laneDir, same lanePos, and position ahead in movement direction
    3. If car within 15 units ahead, slow down proportionally (closer = slower)
    4. If car within 5 units, stop completely (speed = 0)
    5. Resume normal speed when car ahead moves away

    Simple distance check, not full collision detection:
    - Same lane = same laneDir AND abs(lanePos difference) < 4 (lane width)
    - Ahead check based on movement direction and position delta

    This creates natural traffic flow without complex physics.
  </action>
  <verify>npm run build passes</verify>
  <done>Cars slow down when approaching car ahead, no rear-ending</done>
</task>

<task type="auto">
  <name>Task 2: Add player avoidance and honking</name>
  <files>src/traffic/TrafficManager.ts, src/traffic/types.ts</files>
  <action>
    Add player-reactive behavior:
    1. Check distance from each car to player position (passed to update())
    2. If player within 20 units AND in car's path (ahead in lane):
       - Set car.honking = true, car.honkTime = timestamp
       - Reduce speed by 50%
    3. If player within 10 units (very close):
       - Emergency brake (speed = 0)
       - Slight lateral offset (swerve) if player blocking lane
    4. Honk visual: flash car color or add small cube on top when honking
    5. Honk duration: 0.5 seconds, then reset honking flag

    Add to TrafficCar interface:
    - honking: boolean
    - honkTime: number

    Player "in path" check:
    - Player is ahead of car in movement direction
    - Player lateral distance < 6 units (lane width + buffer)
  </action>
  <verify>npm run build passes</verify>
  <done>Cars honk and slow when player in their path, emergency stop when very close</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Traffic AI with collision avoidance and player reactions</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Drive around and observe traffic:
       - Cars should follow lanes smoothly
       - Cars should slow down when approaching car ahead
       - No cars crashing through each other
    3. Test player interaction:
       - Drive into oncoming traffic lane
       - Cars should honk (visual indicator) and slow down
       - Cars should stop if you block them completely
    4. Check overall feel:
       - Traffic feels alive, not robotic
       - Reactions are noticeable but not over-the-top
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] Cars maintain following distance (no pile-ups)
- [ ] Cars react to player presence (honk, slow, stop)
- [ ] Reactions feel appropriate (arcade style, not too aggressive)
</verification>

<success_criteria>
- Car-to-car collision avoidance working
- Player avoidance with visual/audio feedback
- Traffic feels reactive and alive
- Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/04-traffic-ai/04-02-SUMMARY.md`
</output>
