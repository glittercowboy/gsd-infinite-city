---
phase: 03-driving-collision
plan: 01
type: execute
---

<objective>
Add arcade-style collision detection so the car bounces off buildings and trees.

Purpose: Make the procedurally generated city feel solid and interactive.
Output: Working collision system where car bounces off all solid objects with satisfying arcade feel.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-driving-collision/03-CONTEXT.md

**Relevant source files:**
@src/car.ts
@src/chunk/ChunkManager.ts
@src/chunk/BuildingGenerator.ts
@src/chunk/TreeGenerator.ts
@src/chunk/types.ts

**Prior decisions affecting this phase:**
- WeakMap for car physics state (Phase 1) - collision state integrates here
- Chunk size 64 units - collision checks scoped to current chunk
- One InstancedMesh per chunk - need separate collision data (Box3 arrays) not mesh collision
- BuildingData and TreeData already have position/dimensions - directly convertible to Box3

**Deferred issues being addressed:**
None

**Concerns being verified:**
None from prior phases
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add collision data storage to ChunkManager</name>
  <files>src/chunk/types.ts, src/chunk/ChunkManager.ts, src/collision.ts</files>
  <action>
    1. Update Chunk interface in types.ts to add `colliders: THREE.Box3[]` field
    2. Create new src/collision.ts module with:
       - `buildingToBox3(building: BuildingData, worldX: number, worldZ: number): THREE.Box3` - converts building data to world-space Box3
       - `treeToBox3(tree: TreeData, worldX: number, worldZ: number): THREE.Box3` - converts tree data to world-space Box3 (use trunk radius for X/Z, full height for Y)
    3. In ChunkManager.loadChunk(), after generating buildings and trees:
       - Create Box3 array from all buildings using buildingToBox3
       - Create Box3 array from all trees using treeToBox3
       - Combine into single colliders array
       - Store in Chunk object
    4. Add public method `getCollidersAt(position: THREE.Vector3): THREE.Box3[]` that returns colliders for the chunk containing the position

    Use THREE.Box3 with setFromCenterAndSize() for trees (cylindrical approximated as box).
    Buildings already have position as corner + width/depth, so use set(min, max).
  </action>
  <verify>TypeScript compiles. Add console.log in getCollidersAt to verify it returns colliders when car moves.</verify>
  <done>ChunkManager stores Box3 colliders per chunk and exposes getCollidersAt() method.</done>
</task>

<task type="auto">
  <name>Task 2: Implement collision detection and bounce response</name>
  <files>src/car.ts, src/main.ts</files>
  <action>
    1. In car.ts, add to CarPhysics interface: `boundingBox: THREE.Box3` (car's AABB)
    2. In createCar(), initialize boundingBox based on car body size (2x1x4 units)
    3. Create new function `checkCollision(car: THREE.Group, colliders: THREE.Box3[]): THREE.Vector3 | null`:
       - Update car's boundingBox position to match car.position
       - For each collider, check if car.boundingBox.intersectsBox(collider)
       - If collision found, calculate push direction (center of car - center of collider, normalized)
       - Return push direction vector, or null if no collision
    4. Create new function `applyBounce(car: THREE.Group, pushDirection: THREE.Vector3)`:
       - Get physics from WeakMap
       - Reflect velocity: negate the component of velocity in the push direction
       - Apply bounce coefficient 0.5 (preserves half speed)
       - Push car position out of collision by a small amount (0.5 units) in push direction
    5. In updateCar(), after position update:
       - Export a hook or accept colliders as parameter
       - If colliders provided, call checkCollision and applyBounce if needed
    6. In main.ts game loop:
       - After calling updateCar, get colliders from chunkManager.getCollidersAt(car.position)
       - Pass to collision check function (or refactor updateCar to accept colliders)

    Keep bounce coefficient at 0.5 initially (balanced feel). Can tune later.
  </action>
  <verify>npm run build succeeds. Console.log collision detections. Drive into building to see bounce behavior.</verify>
  <done>Car bounces off buildings and trees. Bounce reduces speed by ~50%. No clipping through objects.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Collision detection with arcade bounce</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:5173 (or whatever port Vite uses)
    3. Drive into a building:
       - Car should stop/bounce back
       - No clipping through building
       - Speed should reduce noticeably
    4. Drive into a tree:
       - Same bounce behavior
       - Tree collision feels solid
    5. Navigate tight spaces between buildings:
       - Should be able to squeeze through without getting stuck
       - No jittery bouncing
    6. Check FPS (open browser DevTools > Performance):
       - Should maintain 30+ FPS while driving with collision active
  </how-to-verify>
  <resume-signal>Type "approved" if collision feels arcade-satisfying, or describe issues (too bouncy, not bouncy enough, stuck on objects, etc.)</resume-signal>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] No TypeScript errors
- [ ] Car bounces off buildings (no clipping)
- [ ] Car bounces off trees (no clipping)
- [ ] 30+ FPS maintained with collision active
- [ ] Bounce feel is arcade-satisfying (not frustrating)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Car collides with all solid objects and bounces with arcade feel
- Performance maintained (collision doesn't tank FPS)
</success_criteria>

<output>
After completion, create `.planning/phases/03-driving-collision/03-01-SUMMARY.md`:

# Phase 3 Plan 1: Driving & Collision Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description
- `path/to/another.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

[Phase complete, ready for next phase]
</output>
