---
phase: 06-quick-fixes-atmosphere
plan: 01
type: execute
---

<objective>
Fix tree spawn padding near roads and implement full atmospheric celestial system.

Purpose: Address TO-DO bug where trees spawn too close to roads, and transform the sky from a simple color gradient into an immersive atmosphere with visible sun, moon, stars, and dramatic sunrise/sunset glow.
Output: Trees respecting road buffer zones, visible celestial bodies moving across the sky, stars at night, moon phases, enhanced sky colors during transitions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Relevant source files:**
@src/chunk/TreeGenerator.ts
@src/daynight.ts
@src/scene.ts

**Prior decisions affecting this phase:**
- P2: Tree placement with collision - Trees avoid roads (0,32,64) and building footprints
- P2: HALF_ROAD = ROAD_WIDTH / 2 used for road bounds checking
- P5: 2-minute day/night cycle - Full cycle in 120 seconds
- P5: Smoothstep color interpolation - Prevents abrupt transitions
- P5: timeOfDay 0.25=noon, 0.75=midnight convention

**User aesthetic requirements (from milestone discussion):**
- Full atmosphere: sunrise/sunset glow, moon phases, stars at night
- Directional lighting from sun/moon (already partially implemented)
- Subtle, polished effects (not arcade-y)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix tree spawn road padding</name>
  <files>src/chunk/TreeGenerator.ts</files>
  <action>
Modify `isInRoad()` function to accept an optional `radius` parameter and check if position + radius overlaps road bounds:

1. Change signature: `function isInRoad(x: number, z: number, radius: number = 0): boolean`
2. Update check: `Math.abs(x - roadPos) < HALF_ROAD + radius` (same for z)
3. Update call site in tree generation loop: `isInRoad(x, z, radius)`

This ensures trees with large canopies don't visually overlap road edges.
  </action>
  <verify>
Build succeeds: `npm run build`
Trees visually separated from roads when running `npm run dev`
  </verify>
  <done>isInRoad() accepts radius parameter, tree spawn loop passes tree radius, no trees overlap roads</done>
</task>

<task type="auto">
  <name>Task 2: Implement full celestial system</name>
  <files>src/daynight.ts, src/scene.ts</files>
  <action>
**In src/daynight.ts:**

1. Add method `getMoonPhase(): number` - Returns 0-1 based on 8-day lunar cycle (timeOfDay advances ~0.125 per full day cycle, so use modulo to create ~8 phase states)

2. Add method `isNight(): boolean` - Returns true when timeOfDay > 0.8 or < 0.1

3. Enhance `getSkyColor()` with more dramatic sunrise/sunset:
   - Add warm orange/pink glow during 0.15-0.25 (dawn) and 0.65-0.80 (dusk)
   - Use gradient from horizon color toward zenith

4. Export constants for celestial object positioning

**In src/scene.ts:**

1. Create sun mesh:
   - Yellow emissive sphere (MeshBasicMaterial so unaffected by lighting)
   - Size ~2 units diameter
   - Position from `dayNightCycle.getSunPosition()`
   - Fade opacity to 0 when below horizon (y < 0)

2. Create moon mesh:
   - Gray/white sphere (MeshBasicMaterial)
   - Smaller than sun (~1.5 units)
   - Position opposite sun (add 0.5 to timeOfDay, wrap)
   - Implement phase by using a dark sphere overlay or adjusting emissive based on phase

3. Create star field:
   - Use THREE.Points with BufferGeometry
   - ~500 points on large sphere (radius 200)
   - Small white particles
   - Fade in when `isNight()`, fade out during day
   - Stars should NOT move (fixed celestial sphere)

4. Update animation loop:
   - Update sun mesh position each frame
   - Update moon mesh position each frame
   - Update star opacity based on night state
   - Sun/moon emissive intensity based on time (sun bright at noon, moon bright at midnight)

**Visual targets:**
- Sun visible as glowing orb tracking the directional light position
- Moon rises as sun sets, shows phase (crescent to full)
- Stars fade in during twilight, visible at night
- No visual popping - all transitions smooth
  </action>
  <verify>
Build succeeds: `npm run build`
Run `npm run dev` and observe:
- Sun visible during day, tracks across sky
- Moon visible at night, opposite sun position
- Stars appear at night and fade during dawn
- Sunrise/sunset has warm glow colors
  </verify>
  <done>
Sun mesh visible and positioned correctly
Moon mesh visible with phase indicator
Star field fades in/out with night cycle
Enhanced sky colors during transitions
All celestial objects animate smoothly
  </done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run dev` shows trees properly spaced from roads
- [ ] Sun visible and tracking across sky during day
- [ ] Moon visible during night with phase representation
- [ ] Stars fade in at night, fade out at dawn
- [ ] No visual popping or jarring transitions
- [ ] Performance acceptable (no FPS drop from new meshes)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Tree spawn padding prevents road overlap
- Full celestial system with sun, moon, stars operational
- Smooth atmospheric transitions throughout day/night cycle
</success_criteria>

<output>
After completion, create `.planning/phases/06-quick-fixes-atmosphere/06-01-SUMMARY.md`:

# Phase 6 Plan 01: Quick Fixes + Atmosphere Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Phase complete, ready for Phase 7: Gameplay Feel
</output>
