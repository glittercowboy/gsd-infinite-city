---
phase: 02-procedural-city
plan: 03
type: execute
---

<objective>
Generate buildings along roads using InstancedMesh for performance.

Purpose: Populate the city with varied buildings that give each area visual identity.
Output: Buildings of varying heights placed along road edges, rendered efficiently with InstancedMesh.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-procedural-city/02-CONTEXT.md
@.planning/phases/02-procedural-city/02-02-SUMMARY.md

@src/chunk/ChunkManager.ts
@src/chunk/RoadGenerator.ts
@src/chunk/types.ts
@src/chunk/SeededRandom.ts

**Prior decisions:**
- Chunk size: 64x64 units, Block size: 32 units
- Road width: 8 units
- Seeded random for reproducibility
- Low-poly stylized aesthetic

**Design decisions for this plan:**
- Building footprint: 8x8 to 16x16 units (varied)
- Building heights: 10-80 units (varied by district, but uniform for now)
- Building setback: 2 units from road edge
- Buildings per block: ~4-8 (varied density)
- Use InstancedMesh with BoxGeometry for buildings
- Building colors: Varied grays, tans, whites (low-poly aesthetic)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BuildingGenerator with placement logic</name>
  <files>src/chunk/BuildingGenerator.ts, src/chunk/types.ts</files>
  <action>
1. Update `src/chunk/types.ts`:
   - Add `BuildingData` interface: { position: Vector3, width: number, depth: number, height: number, color: number }
   - Add BUILDING_SETBACK = 2

2. Create `src/chunk/BuildingGenerator.ts`:
   - `generateBuildings(coord: ChunkCoord, roads: RoadSegment[], random: SeededRandom): BuildingData[]`
   - For each block (4 blocks per chunk, between roads):
     - Calculate buildable area (block minus road setbacks)
     - Place 4-8 buildings along block edges (facing roads)
     - Randomize: footprint (8-16 width, 8-16 depth), height (10-60 units), color
     - Colors: Pick from palette [0xE8E8E8, 0xD3D3D3, 0xBEBEBE, 0xC4B7A6, 0xDDCFC4]
     - Avoid overlapping buildings (simple grid placement within block)
   - Return array of BuildingData in local chunk coordinates
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>BuildingGenerator produces building placement data per chunk</done>
</task>

<task type="auto">
  <name>Task 2: Render buildings with InstancedMesh and integrate</name>
  <files>src/chunk/BuildingGenerator.ts, src/chunk/ChunkManager.ts</files>
  <action>
1. In `src/chunk/BuildingGenerator.ts`:
   - `createBuildingMeshes(buildings: BuildingData[], chunkGroup: THREE.Group)`:
   - Create ONE InstancedMesh per chunk for all buildings (performance)
   - Use BoxGeometry(1, 1, 1) as base, scale via matrix for each instance
   - MeshLambertMaterial with vertexColors enabled
   - For each building:
     - Create transformation matrix: translate to position, scale to width/height/depth
     - Set instance matrix with setMatrixAt()
     - Set instance color with setColorAt()
   - Add mesh to chunkGroup

2. In `src/chunk/ChunkManager.ts`:
   - Import BuildingGenerator
   - In loadChunk: After roads, call generateBuildings and createBuildingMeshes
   - Pass road segments to BuildingGenerator (needed for placement logic)

3. Ensure proper disposal:
   - In unloadChunk, InstancedMesh geometry and material are disposed
  </action>
  <verify>`npm run dev` - buildings appear along roads as you drive</verify>
  <done>Buildings render via InstancedMesh with varied sizes and colors</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Building generation system with InstancedMesh rendering</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Drive around the city
    3. Confirm: Buildings appear along road edges
    4. Confirm: Buildings have varied heights and sizes
    5. Confirm: Buildings have varied colors (grays, tans)
    6. Confirm: Buildings don't overlap each other
    7. Confirm: Buildings don't overlap roads
    8. Check DevTools Performance tab - should maintain 30+ FPS
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] Buildings generate in every chunk
- [ ] InstancedMesh used (check with THREE inspector or draw call count)
- [ ] Performance maintained at 30+ FPS
- [ ] No building/road overlaps
</verification>

<success_criteria>
- Buildings placed along road edges with setback
- Building heights, widths, depths vary procedurally
- Building colors create visual variety
- InstancedMesh provides efficient rendering
- Same seed produces identical building layouts
- No overlapping geometry
</success_criteria>

<output>
After completion, create `.planning/phases/02-procedural-city/02-03-SUMMARY.md`
</output>
