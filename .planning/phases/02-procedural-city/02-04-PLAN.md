---
phase: 02-procedural-city
plan: 04
type: execute
---

<objective>
Implement district system for varied city areas and add trees/props.

Purpose: Create visually distinct neighborhoods and natural elements for atmosphere.
Output: Downtown (tall), suburbs (low), industrial (warehouses), parks (trees) - each chunk belongs to a district type.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-procedural-city/02-CONTEXT.md
@.planning/phases/02-procedural-city/02-03-SUMMARY.md

@src/chunk/ChunkManager.ts
@src/chunk/BuildingGenerator.ts
@src/chunk/types.ts
@src/chunk/SeededRandom.ts

**Prior decisions:**
- Chunk size: 64 units
- Seeded random for reproducibility
- InstancedMesh for buildings
- Hard district boundaries acceptable (per context)

**Design decisions for this plan:**
- District types: downtown, suburbs, industrial, park
- District distribution: Perlin noise (2D simplex noise)
- Downtown: Height 40-80, dense, glass colors (blues, greens)
- Suburbs: Height 8-15, sparse, warm colors (tans, whites)
- Industrial: Height 15-30, medium density, grays
- Park: No buildings, trees and grass only
- Trees: Green cone (trunk + foliage) using InstancedMesh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DistrictManager with noise-based district assignment</name>
  <files>src/chunk/DistrictManager.ts, src/chunk/types.ts, src/chunk/SimplexNoise.ts</files>
  <action>
1. Create `src/chunk/SimplexNoise.ts`:
   - Implement 2D simplex noise function (or use a simple Perlin approximation)
   - `noise2D(x: number, y: number, seed: number): number` returns -1 to 1
   - Use standard simplex noise algorithm (grad, permutation table seeded)

2. Update `src/chunk/types.ts`:
   - Add `DistrictType = 'downtown' | 'suburbs' | 'industrial' | 'park'`
   - Add `DistrictConfig` interface: { minHeight, maxHeight, density, colors, hasBuildings }

3. Create `src/chunk/DistrictManager.ts`:
   - `getDistrictType(coord: ChunkCoord, seed: number): DistrictType`
   - Sample noise at chunk center (coord.x * CHUNK_SIZE + 32, coord.z * CHUNK_SIZE + 32)
   - Use two noise samples at different frequencies for variety
   - Map noise value to district: <-0.3 park, -0.3-0.1 suburbs, 0.1-0.5 industrial, >0.5 downtown
   - `getDistrictConfig(type: DistrictType): DistrictConfig`
   - Return config object with height ranges, density multiplier, color palette
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>DistrictManager assigns district types based on chunk position</done>
</task>

<task type="auto">
  <name>Task 2: Apply district configs to building generation and add trees</name>
  <files>src/chunk/BuildingGenerator.ts, src/chunk/TreeGenerator.ts, src/chunk/ChunkManager.ts</files>
  <action>
1. Update `src/chunk/BuildingGenerator.ts`:
   - `generateBuildings` now takes `districtConfig: DistrictConfig` parameter
   - Use config.minHeight/maxHeight for building heights
   - Use config.density to adjust buildings per block (0.5 = half, 1.5 = more)
   - Use config.colors array for building colors
   - If !config.hasBuildings, return empty array (for parks)

2. Create `src/chunk/TreeGenerator.ts`:
   - `generateTrees(coord: ChunkCoord, districtType: DistrictType, random: SeededRandom): TreeData[]`
   - Parks: 20-40 trees scattered across chunk
   - Suburbs: 5-10 trees (yard trees)
   - Downtown/Industrial: 0-2 trees (rare street trees)
   - TreeData: { position: Vector3, height: number, radius: number }
   - `createTreeMeshes(trees: TreeData[], chunkGroup: THREE.Group)`:
   - InstancedMesh for trunks (CylinderGeometry, brown 0x8B4513)
   - InstancedMesh for foliage (ConeGeometry, green 0x228B22 with variation)

3. Update `src/chunk/ChunkManager.ts`:
   - Import DistrictManager, TreeGenerator
   - In loadChunk: Get district type, pass config to BuildingGenerator
   - Call TreeGenerator after buildings
   - For parks: Use lighter green ground color (0x32CD32)
  </action>
  <verify>`npm run dev` - districts visible with different building styles and trees</verify>
  <done>Districts affect building generation, trees appear in appropriate areas</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>District variation system with trees and props</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Drive around extensively (explore different directions)
    3. Confirm: Downtown areas have tall buildings (40-80 units)
    4. Confirm: Suburban areas have short buildings (8-15 units)
    5. Confirm: Industrial areas have medium warehouse-style buildings
    6. Confirm: Park areas have no buildings, many trees, lighter grass
    7. Confirm: Trees visible in parks and scattered in suburbs
    8. Confirm: District boundaries are visible but not jarring
    9. Check performance - should maintain 30+ FPS
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] All four district types appear when exploring
- [ ] Building characteristics match district type
- [ ] Trees render correctly with InstancedMesh
- [ ] Performance maintained at 30+ FPS
- [ ] Same seed produces identical district layout
</verification>

<success_criteria>
- Districts determined by noise-based algorithm
- Downtown: Tall dense buildings, blue/green glass colors
- Suburbs: Short sparse buildings, warm colors, yard trees
- Industrial: Medium warehouses, gray colors
- Parks: No buildings, many trees, light green grass
- Trees render efficiently via InstancedMesh
- Reproducible with same seed
- Phase 2 complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-procedural-city/02-04-SUMMARY.md`

Include in summary:
- Phase 2 complete
- Ready for Phase 3: Driving & Collision
</output>
