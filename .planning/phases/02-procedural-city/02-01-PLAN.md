---
phase: 02-procedural-city
plan: 01
type: execute
---

<objective>
Implement chunk-based world system that loads/unloads terrain chunks based on car position.

Purpose: Foundation for infinite procedural city - chunks spawn around player and despawn when distant.
Output: ChunkManager class, ground tiles per chunk, visible chunk loading/unloading as car drives.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-procedural-city/02-CONTEXT.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

@src/scene.ts
@src/car.ts

**Prior decisions affecting this plan:**
- WeakMap pattern for associating data with objects (from Phase 1)
- Car position drives camera; use car position for chunk loading too

**Design decisions for this phase:**
- Chunk size: 64x64 units (balance between granularity and performance)
- View distance: 3 chunks radius (7x7 = 49 max loaded chunks)
- Cache distance: 5 chunks radius (recently visited stay loaded)
- Seeded random: Use mulberry32 PRNG for reproducibility
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ChunkManager and seeded RNG utility</name>
  <files>src/chunk/ChunkManager.ts, src/chunk/SeededRandom.ts, src/chunk/types.ts</files>
  <action>
Create chunk system foundation:

1. `src/chunk/types.ts`:
   - `ChunkCoord` interface: { x: number, z: number }
   - `Chunk` interface: { coord: ChunkCoord, group: THREE.Group, lastVisited: number }
   - Export CHUNK_SIZE = 64, VIEW_DISTANCE = 3, CACHE_DISTANCE = 5

2. `src/chunk/SeededRandom.ts`:
   - `createSeededRandom(seed: number)` returning object with `random()` method
   - Use mulberry32 algorithm (fast, good distribution)
   - `hashCoord(x: number, z: number, seed: number): number` for chunk-specific seeds

3. `src/chunk/ChunkManager.ts`:
   - Constructor takes scene and baseSeed
   - `chunks: Map<string, Chunk>` for loaded chunks (key = "x,z")
   - `update(carPosition: THREE.Vector3)`: Calculate car's chunk coord, load/unload as needed
   - `loadChunk(coord: ChunkCoord)`: Create chunk group, add ground tile, add to scene
   - `unloadChunk(coord: ChunkCoord)`: Remove from scene, dispose geometry/materials
   - `getChunksInRadius(center: ChunkCoord, radius: number): ChunkCoord[]`
   - Proper THREE.js disposal in unloadChunk (geometry.dispose(), material.dispose())
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>ChunkManager class exists with load/unload logic, seeded RNG utility created</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ChunkManager with scene and render ground tiles</name>
  <files>src/scene.ts, src/chunk/ChunkManager.ts</files>
  <action>
1. Modify `src/scene.ts`:
   - Import ChunkManager
   - Remove fixed 100x100 ground plane
   - Create ChunkManager instance with scene and seed (use 12345 as default)
   - In animation loop, call `chunkManager.update(car.position)`
   - Add fog to scene: `scene.fog = new THREE.Fog(0x87CEEB, 100, 300)` (sky color, start, end)
   - Adjust camera far plane to 400 (beyond fog end)

2. In ChunkManager.loadChunk:
   - Create ground tile: PlaneGeometry(CHUNK_SIZE, CHUNK_SIZE)
   - Position at chunk world coords: (coord.x * CHUNK_SIZE, 0, coord.z * CHUNK_SIZE)
   - Use MeshLambertMaterial with green color (0x228B22)
   - Rotate plane to horizontal (-Math.PI/2 on X)
   - Add slight color variation per chunk using seeded random (subtle, +/- 10% brightness)
  </action>
  <verify>`npm run dev` - car drives over chunked ground tiles instead of single plane</verify>
  <done>Ground tiles generate as car moves, old ground plane removed, fog hides edges</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Chunk-based ground system with load/unload and fog</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Drive the car in any direction for 20+ seconds
    3. Confirm: Ground tiles appear ahead as you drive
    4. Confirm: No visible "pop-in" - fog hides chunk edges
    5. Open browser DevTools console, check for errors
    6. Confirm: No memory warnings after extended driving (1+ minute)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] Chunks load/unload as car position changes
- [ ] Fog creates smooth visual transition
- [ ] No console errors during extended driving
</verification>

<success_criteria>
- ChunkManager loads chunks within VIEW_DISTANCE of car
- ChunkManager unloads chunks beyond CACHE_DISTANCE
- Ground tiles render at correct world positions
- Seeded random produces consistent results for same chunk
- No visual popping due to fog coverage
- No memory leaks (proper disposal)
</success_criteria>

<output>
After completion, create `.planning/phases/02-procedural-city/02-01-SUMMARY.md`
</output>
