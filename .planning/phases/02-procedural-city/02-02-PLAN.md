---
phase: 02-procedural-city
plan: 02
type: execute
---

<objective>
Generate road network within chunks using a grid-with-variation approach.

Purpose: Roads define where cars can drive and where buildings can be placed.
Output: Road meshes rendered in each chunk, aligned at chunk boundaries, with slight variation from perfect grid.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-procedural-city/02-CONTEXT.md
@.planning/phases/02-procedural-city/02-01-SUMMARY.md

@src/chunk/ChunkManager.ts
@src/chunk/types.ts
@src/chunk/SeededRandom.ts

**Prior decisions:**
- Chunk size: 64x64 units
- Seeded random for reproducibility
- Grid with variation for roads (from context)

**Design decisions for this plan:**
- Road width: 8 units (2 lanes each direction)
- Block size: 32 units (2x2 blocks per chunk = 4 intersections)
- Road variation: Perlin-like noise offsets on non-boundary roads (max 4 units)
- Road material: Dark gray asphalt color (0x333333)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RoadGenerator with grid layout logic</name>
  <files>src/chunk/RoadGenerator.ts, src/chunk/types.ts</files>
  <action>
1. Update `src/chunk/types.ts`:
   - Add ROAD_WIDTH = 8, BLOCK_SIZE = 32
   - Add `RoadSegment` interface: { start: Vector2, end: Vector2, isMainRoad: boolean }

2. Create `src/chunk/RoadGenerator.ts`:
   - `generateRoads(coord: ChunkCoord, random: SeededRandom): RoadSegment[]`
   - Generate horizontal roads at z = 0 and z = BLOCK_SIZE (2 per chunk)
   - Generate vertical roads at x = 0 and x = BLOCK_SIZE (2 per chunk)
   - Roads at chunk edges (x=0, z=0, x=64, z=64) are "main roads" - no offset
   - Interior roads get small random offset (seeded, max 2 units) for variation
   - Return array of road segments in local chunk coordinates
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>RoadGenerator produces road segment data for a chunk</done>
</task>

<task type="auto">
  <name>Task 2: Render roads with InstancedMesh and integrate with ChunkManager</name>
  <files>src/chunk/RoadGenerator.ts, src/chunk/ChunkManager.ts</files>
  <action>
1. In `src/chunk/RoadGenerator.ts`:
   - `createRoadMeshes(segments: RoadSegment[], chunkGroup: THREE.Group)`:
   - Use PlaneGeometry for road surface (width=ROAD_WIDTH, length=segment length)
   - MeshLambertMaterial with color 0x333333 (dark gray asphalt)
   - Position slightly above ground (y = 0.01) to prevent z-fighting
   - Rotate to horizontal, then rotate to match segment direction
   - For now, create individual meshes (not InstancedMesh yet - roads vary in length)
   - Add yellow center line: thin plane (0.2 width) with color 0xFFFF00

2. In `src/chunk/ChunkManager.ts`:
   - Import RoadGenerator
   - In loadChunk: After ground tile, call generateRoads and createRoadMeshes
   - Pass chunk's seeded random to generateRoads
  </action>
  <verify>`npm run dev` - roads visible on chunks as car drives</verify>
  <done>Roads render in each chunk with grid layout and slight variation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Road network with grid-based layout and variation</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Drive around and observe road network
    3. Confirm: Roads form mostly-grid pattern
    4. Confirm: Roads at chunk boundaries align (no gaps/overlaps)
    5. Confirm: Interior roads have slight variation (not perfectly straight)
    6. Confirm: Yellow center lines visible
    7. Confirm: Roads render above grass (no z-fighting flicker)
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] Roads generate in every chunk
- [ ] Chunk boundary roads align perfectly
- [ ] No z-fighting between roads and ground
</verification>

<success_criteria>
- Road grid generates procedurally per chunk
- Roads align at chunk boundaries (main roads fixed position)
- Interior roads have reproducible variation (same seed = same layout)
- Road meshes render correctly with center lines
- No visual artifacts or z-fighting
</success_criteria>

<output>
After completion, create `.planning/phases/02-procedural-city/02-02-SUMMARY.md`
</output>
